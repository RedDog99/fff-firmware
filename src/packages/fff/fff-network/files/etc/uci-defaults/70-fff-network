#!/bin/sh

# load current board config
BOARD="$(uci get board.model.name)"
. /etc/network.$BOARD

# remove unused global ipv6 net
uci del network.globals

# compute some macs
LANIFACE="$(uci get network.lan.ifname)"
#LANMAC="$(cat "/sys/class/net/${LANIFACE}/address" | awk -F: '{ printf("%x:%s:%s:%s:%s:%s", xor("0x"$1, 0x2), $2, $3, $4, $5, $6) }')"
LANMAC="$(cat "/sys/class/net/${LANIFACE}/address")"
if [[ -n "${ETHMESHMAC}" ]]; then
    LANMAC="$(cat "/sys/class/net/${ETHMESHMAC}/address")"
fi

uci batch <<EOF
set network.lan.proto='bcswitch'
del network.lan.type
set network.lan.mesh='bat0'
set network.lan.mesh_no_rebroadcast='1'
set network.lan.macaddr='${LANMAC}'

set network.mesh=interface
set network.mesh.type='bridge'
set network.mesh.auto='1'
set network.mesh.ifname='${LANIFACE} bat0'

commit network
EOF

if [[ -n "$ROUTERMAC" ]]; then
    NEW_MACADDR=$(cat "/sys/class/net/${ROUTERMAC}/address")
    uci set network.mesh.macaddr="$NEW_MACADDR"
    uci commit
fi

#if [[ -n "$ETH0MAC" ]]; then
#    NEW_MACADDR=$(cat "/sys/class/net/${ETH0MAC}/address")
#    uci set network.eth0.macaddr=$NEW_MACADDR
#    uci commit
#fi
